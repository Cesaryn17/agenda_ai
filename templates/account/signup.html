{% extends "account/base.html" %}
{% load i18n %}
{% load socialaccount %}
{% load static %}

{% block content %}
<div class="auth-header">
    <h1>Criar sua conta</h1>
    <p>Preencha os dados abaixo para se registrar</p>
</div>

{% if form.errors %}
<div class="messages">
    <div class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i>
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                {{ error }}<br>
            {% endfor %}
        {% endfor %}
    </div>
</div>
{% endif %}

<form class="auth-form" method="POST" id="registerForm" action="{% url 'account_signup' %}">
    {% csrf_token %}
    
    <div class="form-group">
        <label for="id_nome">Nome completo *</label>
        <div class="input-with-icon">
            <i class="fas fa-user"></i>
            <input type="text" id="id_nome" name="nome" class="form-input" placeholder="Seu nome completo" required autofocus value="{{ form.nome.value|default:'' }}">
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="id_email">E-mail *</label>
            <div class="input-with-icon">
                <i class="fas fa-envelope"></i>
                <input type="email" id="id_email" name="email" class="form-input" placeholder="seu@email.com" required value="{{ form.email.value|default:'' }}">
            </div>
        </div>
        
        <div class="form-group">
            <label for="id_phone">Telefone</label>
            <div class="input-with-icon">
                <i class="fas fa-phone"></i>
                <input type="tel" id="id_phone" name="phone" class="form-input" placeholder="(11) 99999-9999" value="{{ form.phone.value|default:'' }}">
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <label for="id_password1">Senha *</label>
        <div class="input-with-icon password-container">
            <i class="fas fa-lock"></i>
            <input type="password" id="id_password1" name="password1" class="form-input password-input" placeholder="Crie uma senha segura" required minlength="6">
            <span class="password-toggle" id="togglePassword">
                <i class="fas fa-eye"></i>
            </span>
        </div>
        
        <div class="password-strength-container">
            <div class="password-strength-header">
                <span>Força da senha:</span>
                <span id="password-strength-text">Digite sua senha</span>
            </div>
            <div class="password-strength-bar-container">
                <div class="password-strength-bar" id="password-strength-bar"></div>
            </div>
            
            <div class="password-requirements">
                <div class="requirement" id="length-req">
                    <i class="fas fa-circle requirement-icon"></i>
                    <span>Mínimo 6 caracteres</span>
                </div>
                <div class="requirement" id="number-req">
                    <i class="fas fa-circle requirement-icon"></i>
                    <span>Pelo menos 1 número</span>
                </div>
                <div class="requirement" id="letter-req">
                    <i class="fas fa-circle requirement-icon"></i>
                    <span>Pelo menos 1 letra</span>
                </div>
                <div class="requirement" id="special-req">
                    <i class="fas fa-circle requirement-icon"></i>
                    <span>Caractere especial (!@#$)</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <label for="id_password2">Confirmar senha *</label>
        <div class="input-with-icon password-container">
            <i class="fas fa-lock"></i>
            <input type="password" id="id_password2" name="password2" class="form-input password-input" placeholder="Digite novamente sua senha" required>
            <span class="password-toggle" id="toggleConfirmPassword">
                <i class="fas fa-eye"></i>
            </span>
        </div>
        <div class="field-error" id="password-error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span>As senhas não coincidem</span>
        </div>
    </div>
    
    <div class="terms-group">
        <input type="checkbox" id="id_terms" name="terms" required>
        <label for="id_terms" class="terms-label">
            Concordo com os <a href="{% url 'termos_condicoes' %}" target="_blank">Termos de Uso</a> e 
            <a href="#" target="_blank">Política de Privacidade</a> da Agenda AI *
        </label>
    </div>
    <div class="field-error" id="terms-error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span>Você deve aceitar os termos de uso</span>
    </div>

    {% if redirect_field_value %}
    <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}" />
    {% endif %}
    
    <button type="submit" class="auth-button" id="submitButton">
        <i class="fas fa-user-plus" style="margin-right: 8px;"></i>
        Criar conta
    </button>
</form>

<div class="divider">
    <span>Ou cadastre-se com</span>
</div>

<div class="social-login">
    <a href="{% provider_login_url 'google' %}" class="social-btn google">
        <i class="fab fa-google"></i>
        Google
    </a>
    
    <a href="{% provider_login_url 'facebook' %}" class="social-btn facebook">
        <i class="fab fa-facebook-f"></i>
        Facebook
    </a>
</div>

<div class="auth-footer">
    <p>Já tem uma conta? <a href="{% url 'account_login' %}">Faça login</a></p>
</div>

<style>
.password-strength-container {
    margin-top: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.password-strength-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 14px;
    font-weight: 500;
}

#password-strength-text {
    font-weight: 600;
    transition: color 0.3s ease;
}

.password-strength-bar-container {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 15px;
}

.password-strength-bar {
    height: 100%;
    width: 0%;
    border-radius: 3px;
    transition: all 0.3s ease;
}

.password-strength-weak {
    background: #dc3545;
    width: 25%;
}

.password-strength-fair {
    background: #fd7e14;
    width: 50%;
}

.password-strength-good {
    background: #ffc107;
    width: 75%;
}

.password-strength-strong {
    background: #28a745;
    width: 100%;
}

.password-requirements {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.requirement {
    display: flex;
    align-items: center;
    font-size: 12px;
    color: #6c757d;
}

.requirement-icon {
    font-size: 6px;
    margin-right: 8px;
    transition: color 0.3s ease;
}

.requirement.valid {
    color: #28a745;
}

.requirement.valid .requirement-icon {
    color: #28a745;
}

.requirement.invalid {
    color: #6c757d;
}

.requirement.invalid .requirement-icon {
    color: #6c757d;
}

.password-container {
    position: relative;
}

.password-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6c757d;
    transition: color 0.3s ease;
}

.password-toggle:hover {
    color: #495057;
}

.strength-weak { color: #dc3545; }
.strength-fair { color: #fd7e14; }
.strength-good { color: #ffc107; }
.strength-strong { color: #28a745; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('registerForm');
        const togglePassword = document.getElementById('togglePassword');
        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        const passwordInput = document.getElementById('id_password1');
        const confirmPasswordInput = document.getElementById('id_password2');
        const passwordError = document.getElementById('password-error');
        const termsError = document.getElementById('terms-error');
        const submitButton = document.getElementById('submitButton');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const passwordStrengthText = document.getElementById('password-strength-text');
        const termsCheckbox = document.getElementById('id_terms');
        
        const lengthReq = document.getElementById('length-req');
        const numberReq = document.getElementById('number-req');
        const letterReq = document.getElementById('letter-req');
        const specialReq = document.getElementById('special-req');
        
        function setupPasswordToggle(toggleElement, inputElement) {
            toggleElement.addEventListener('click', function() {
                const type = inputElement.getAttribute('type') === 'password' ? 'text' : 'password';
                inputElement.setAttribute('type', type);
                const eyeIcon = this.querySelector('i');
                eyeIcon.className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
            });
        }
        
        setupPasswordToggle(togglePassword, passwordInput);
        setupPasswordToggle(toggleConfirmPassword, confirmPasswordInput);
        
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            let score = 0;
            let messages = [];
            
            const requirements = {
                length: password.length >= 6,
                number: /\d/.test(password),
                letter: /[a-zA-Z]/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            lengthReq.className = `requirement ${requirements.length ? 'valid' : 'invalid'}`;
            numberReq.className = `requirement ${requirements.number ? 'valid' : 'invalid'}`;
            letterReq.className = `requirement ${requirements.letter ? 'valid' : 'invalid'}`;
            specialReq.className = `requirement ${requirements.special ? 'valid' : 'invalid'}`;
            
            if (requirements.length) score += 25;
            if (requirements.number) score += 25;
            if (requirements.letter) score += 25;
            if (requirements.special) score += 25;
            
            passwordStrengthBar.className = 'password-strength-bar';
            passwordStrengthText.className = '';
            
            if (password.length === 0) {
                passwordStrengthText.textContent = 'Digite sua senha';
                passwordStrengthText.className = '';
            } else if (score <= 25) {
                passwordStrengthBar.classList.add('password-strength-weak');
                passwordStrengthText.textContent = 'Fraca';
                passwordStrengthText.className = 'strength-weak';
            } else if (score <= 50) {
                passwordStrengthBar.classList.add('password-strength-fair');
                passwordStrengthText.textContent = 'Razoável';
                passwordStrengthText.className = 'strength-fair';
            } else if (score <= 75) {
                passwordStrengthBar.classList.add('password-strength-good');
                passwordStrengthText.textContent = 'Boa';
                passwordStrengthText.className = 'strength-good';
            } else {
                passwordStrengthBar.classList.add('password-strength-strong');
                passwordStrengthText.textContent = 'Forte';
                passwordStrengthText.className = 'strength-strong';
            }
            
            validatePasswords();
        });
        
        confirmPasswordInput.addEventListener('input', validatePasswords);
        
        function validatePasswords() {
            const passwordsMatch = passwordInput.value === confirmPasswordInput.value;
            const hasPassword = passwordInput.value.length > 0;
            
            if (!passwordsMatch && hasPassword && confirmPasswordInput.value.length > 0) {
                passwordError.style.display = 'flex';
                submitButton.disabled = true;
                submitButton.style.opacity = '0.6';
            } else {
                passwordError.style.display = 'none';
                submitButton.disabled = false;
                submitButton.style.opacity = '1';
            }
        }
        
        const phoneInput = document.getElementById('id_phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
                
                e.target.value = value;
            });
        }
        
        termsCheckbox.addEventListener('change', function() {
            termsError.style.display = this.checked ? 'none' : 'flex';
        });
        
        form.addEventListener('submit', function(e) {
            let isValid = true;
            
            if (passwordInput.value !== confirmPasswordInput.value) {
                passwordError.style.display = 'flex';
                isValid = false;
            }
            
            if (!termsCheckbox.checked) {
                termsError.style.display = 'flex';
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
                const firstError = document.querySelector('.field-error[style="display: flex;"]');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
        
        document.getElementById('id_nome').focus();
    });
</script>
{% endblock %}