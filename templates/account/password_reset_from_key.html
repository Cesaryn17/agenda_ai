{% extends "account/base.html" %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="auth-header">
    <h1>Nova Senha</h1>
    <p>Crie uma nova senha para sua conta</p>
</div>

{% if form.errors %}
<div class="messages">
    <div class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i>
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                {{ error }}<br>
            {% endfor %}
        {% endfor %}
    </div>
</div>
{% endif %}

<form class="auth-form" method="POST" action="{{ action_url }}">
    {% csrf_token %}
    
    <div class="form-group">
        <label for="id_password1">Nova senha *</label>
        <div class="input-with-icon">
            <i class="fas fa-lock"></i>
            <input type="password" id="id_password1" name="password1" placeholder="Nova senha" required>
            <span class="password-toggle">
                <i class="fas fa-eye"></i>
            </span>
        </div>
        <div class="password-strength">
            <div class="password-strength-bar" id="password-strength-bar"></div>
        </div>
        <div class="password-hints">
            <p>Sua senha deve conter:</p>
            <ul>
                <li id="length-hint" class="hint-invalid">Pelo menos 6 caracteres</li>
                <li id="number-hint" class="hint-invalid">Pelo menos 1 número</li>
                <li id="letter-hint" class="hint-invalid">Pelo menos 1 letra</li>
            </ul>
        </div>
    </div>
    
    <div class="form-group">
        <label for="id_password2">Confirmar nova senha *</label>
        <div class="input-with-icon">
            <i class="fas fa-lock"></i>
            <input type="password" id="id_password2" name="password2" placeholder="Confirmar nova senha" required>
            <span class="password-toggle">
                <i class="fas fa-eye"></i>
            </span>
        </div>
        <div class="field-error" id="password-error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span>As senhas não coincidem</span>
        </div>
    </div>
    
    <button type="submit" class="auth-button" id="submitButton">
        <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>
        Redefinir senha
    </button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('id_password1');
        const confirmPasswordInput = document.getElementById('id_password2');
        const passwordError = document.getElementById('password-error');
        const submitButton = document.getElementById('submitButton');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const lengthHint = document.getElementById('length-hint');
        const numberHint = document.getElementById('number-hint');
        const letterHint = document.getElementById('letter-hint');
        
        const passwordToggles = document.querySelectorAll('.password-toggle');
        
        passwordToggles.forEach(toggle => {
            toggle.addEventListener('click', function() {
                const input = this.closest('.input-with-icon').querySelector('input');
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                
                const eyeIcon = this.querySelector('i');
                if (type === 'password') {
                    eyeIcon.classList.remove('fa-eye-slash');
                    eyeIcon.classList.add('fa-eye');
                } else {
                    eyeIcon.classList.remove('fa-eye');
                    eyeIcon.classList.add('fa-eye-slash');
                }
            });
        });
        
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            if (password.length >= 6) {
                strength += 1;
                lengthHint.classList.remove('hint-invalid');
                lengthHint.classList.add('hint-valid');
            } else {
                lengthHint.classList.remove('hint-valid');
                lengthHint.classList.add('hint-invalid');
            }
            
            if (/\d/.test(password)) {
                strength += 1;
                numberHint.classList.remove('hint-invalid');
                numberHint.classList.add('hint-valid');
            } else {
                numberHint.classList.remove('hint-valid');
                numberHint.classList.add('hint-invalid');
            }
            
            if (/[a-zA-Z]/.test(password)) {
                strength += 1;
                letterHint.classList.remove('hint-invalid');
                letterHint.classList.add('hint-valid');
            } else {
                letterHint.classList.remove('hint-valid');
                letterHint.classList.add('hint-invalid');
            }
            
            passwordStrengthBar.className = 'password-strength-bar';
            if (strength === 1) {
                passwordStrengthBar.classList.add('password-strength-weak');
            } else if (strength === 2) {
                passwordStrengthBar.classList.add('password-strength-medium');
            } else if (strength === 3) {
                passwordStrengthBar.classList.add('password-strength-strong');
            }
            
            validatePasswords();
        });
        
        confirmPasswordInput.addEventListener('input', validatePasswords);
        
        function validatePasswords() {
            if (passwordInput.value !== confirmPasswordInput.value && confirmPasswordInput.value !== '') {
                passwordError.style.display = 'flex';
                submitButton.disabled = true;
            } else {
                passwordError.style.display = 'none';
                submitButton.disabled = false;
            }
        }
        
        passwordInput.focus();
    });
</script>
{% endblock %}